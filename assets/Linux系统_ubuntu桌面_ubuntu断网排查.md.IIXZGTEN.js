import{_ as a,c as e,o as i,ag as t}from"./chunks/framework.DWdSXOaE.js";const k=JSON.parse('{"title":"ubuntu24.04断网排查和修复","description":"","frontmatter":{},"headers":[],"relativePath":"Linux系统/ubuntu桌面/ubuntu断网排查.md","filePath":"Linux系统/ubuntu桌面/ubuntu断网排查.md","lastUpdated":1728643481000}'),n={name:"Linux系统/ubuntu桌面/ubuntu断网排查.md"};function p(l,s,h,d,o,r){return i(),e("div",null,[...s[0]||(s[0]=[t(`<h1 id="ubuntu24-04断网排查和修复" tabindex="-1">ubuntu24.04断网排查和修复 <a class="header-anchor" href="#ubuntu24-04断网排查和修复" aria-label="Permalink to &quot;ubuntu24.04断网排查和修复&quot;">​</a></h1><p>故障描述：</p><p>有线网卡图标找不到，无法上网，并且为wifi无法连接。</p><h2 id="排查思路" tabindex="-1">排查思路 <a class="header-anchor" href="#排查思路" aria-label="Permalink to &quot;排查思路&quot;">​</a></h2><h3 id="_1-查看网卡硬件信息" tabindex="-1">1.查看网卡硬件信息 <a class="header-anchor" href="#_1-查看网卡硬件信息" aria-label="Permalink to &quot;1.查看网卡硬件信息&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lspci</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ethernet</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lshw</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> network</span></span></code></pre></div><p>如果能看到网卡信息，说明驱动正常。</p><h3 id="_2-networkmanager-日志分析" tabindex="-1">2.NetworkManager 日志分析 <a class="header-anchor" href="#_2-networkmanager-日志分析" aria-label="Permalink to &quot;2.NetworkManager 日志分析&quot;">​</a></h3><p>先监控日志</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NetworkManager</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span></span></code></pre></div><p>之后重启服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NetworkManager</span></span></code></pre></div><p>分析期间的日志信息如下：</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>10月 11 15:18:14 没有 NetworkManager[45923]: &lt;info&gt;  [1728631094.5378] settings: Loaded settings plugin: keyfile (internal)</span></span>
<span class="line"><span>10月 11 15:18:14 mypc NetworkManager[45923]: &lt;info&gt;  [1728631094.5378] ifupdown: management mode: unmanaged</span></span>
<span class="line"><span>10月 11 15:18:14 mypc NetworkManager[45923]: &lt;info&gt;  [1728631094.5378] ifupdown: interfaces file /etc/network/interfaces doesn&#39;t exist</span></span>
<span class="line"><span>10月 11 15:18:14 mypc NetworkManager[45968]: /etc/netplan/90-NM-957ea871-bac8-4e88-bd7a-cd135541f3fc.yaml:10:19: Error in network definition: Invalid MAC address &#39;stable-ssid&#39;, must be XX:XX:XX:XX:XX:XX, XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX or one of &#39;permanent&#39;, &#39;random&#39;, &#39;stable&#39;, &#39;preserve&#39;.</span></span>
<span class="line"><span>10月 11 15:18:14 mypc NetworkManager[45968]:       macaddress: &quot;stable-ssid&quot;</span></span>
<span class="line"><span>10月 11 15:18:14 mypc NetworkManager[45968]:                   ^</span></span>
<span class="line"><span>10月 11 15:18:15 mypc NetworkManager[45923]: &lt;info&gt;  [1728631095.2760] dhcp: init: Using DHCP client &#39;internal&#39;</span></span>
<span class="line"><span>10月 11 15:18:15 mypc NetworkManager[45923]: &lt;info&gt;  [1728631095.2762] manager: (lo): new Loopback device (/org/freedesktop/NetworkManager/Devices/1)</span></span>
<span class="line"><span>10月 11 15:18:15 mypc NetworkManager[45923]: &lt;info&gt;  [1728631095.2766] device (br-0ad233ffab7c): carrier: link connected</span></span></code></pre></div><p>这个是bug</p><p><a href="https://bugs.launchpad.net/ubuntu/+source/network-manager/+bug/2084234" target="_blank" rel="noreferrer">https://bugs.launchpad.net/ubuntu/+source/network-manager/+bug/2084234</a></p><p>社区回复说会修复这个问题，是netplan的问题，NetworkManager支持但是netplan不支持<code>stable-ssid</code>，netplan的配置文件格式有误。 可以通过这个命令快速验证同样的问题,输出报错就是netplan配置不对</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> netplan</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span></span></code></pre></div><p>日志分析：查看日志中是否有错误信息，或者提示信息。</p><p>这里看到了 &quot;Invalid MAC address &#39;stable-ssid&#39;&quot;</p><p>这个错误信息表明了在配置文件中定义的 MAC 地址设置不正确。</p><p>这里是因为&quot;stable-ssid&quot;这个设置不再有效，可以手工修改配置文件，或者使用&quot;随机&quot;或者&quot;稳定&quot;等设置。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/netplan/90-NM-957ea871-bac8-4e88-bd7a-cd135541f3fc.yaml</span></span></code></pre></div><p>修改完成之后重启网络服务即可使用wifi。</p><p>重启网络服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NetworkManager</span></span></code></pre></div><p>到这里wifi正常了，有线还是没有操作的地方。</p><h3 id="_3-排查networkmanager管理状态" tabindex="-1">3.排查NetworkManager管理状态 <a class="header-anchor" href="#_3-排查networkmanager管理状态" aria-label="Permalink to &quot;3.排查NetworkManager管理状态&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nmcli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> device</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span></code></pre></div><p>输出显示有线网卡未托管。</p><p>查看排除文件</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/lib/NetworkManager/conf.d/10-globally-managed-devices.conf</span></span></code></pre></div><p>输出:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[keyfile]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">unmanaged-devices</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">*,except:type:wifi,except:type:gsm,except:type:cdma</span></span></code></pre></div><p>10-globally-managed-devices.conf 排除了*保留了wifi和gsm等设备，缺少了以太网。</p><p>解决办法：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/lib/NetworkManager/conf.d/10-globally-managed-devices.conf</span></span></code></pre></div><p>修改成下面</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[keyfile]</span></span>
<span class="line"><span>unmanaged-devices=*,except:type:ethernet,except:type:wifi,except:type:gsm,except:type:cdma</span></span></code></pre></div><p>重启网络服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NetworkManager</span></span></code></pre></div><p>至此有线网卡状态已恢复。</p>`,43)])])}const g=a(n,[["render",p]]);export{k as __pageData,g as default};
